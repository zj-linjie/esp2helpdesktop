# ESP32 媒体功能交接总文档（JC3636W518C）

日期：2026-02-28  
适用仓库：`/Users/apple/dev/esp2helpdesktop`  
目标读者：下一位接手 ESP32 固件与 Electron 协同开发的同事

---

## 1. 文档目的

这份文档把本阶段媒体相关的两类信息合并到一个入口：

1. 上游方案调研结论（厂家/社区示例如何在小内存设备播放图片、MP3、视频）
2. 结合当前项目代码结构的落地实施方案（如何分阶段改造，不中断主线）

来源文档：
- `docs/development/2026-02-28-jc3636-media-playback-research.md`
- `docs/development/2026-02-28-jc3636-media-playback-implementation-v2.md`

---

## 2. 当前项目媒体基线（已确认）

固件端（`esp32-firmware/src/main.cpp`）：
- 当前是单文件主线架构（monolithic）
- 已存在 `UI_PAGE_PHOTO_FRAME` 页面（第 9 页）
- 主循环是协作式：`webSocket.loop()` + `lv_timer_handler()`
- SD 卡链路已具备：
  - 挂载（4-bit 失败回退 1-bit）
  - 卡类型/容量/根目录统计
  - 图片文件扫描与索引
- 相册页 UI 按钮已具备：`Prev / Reload / Next`

现状结论：
- 页面骨架和 SD 基础能力已经有了
- 主要风险点在“解码与渲染链路稳定性”，不是 UI 骨架缺失

---

## 3. 上游示例的关键事实（为什么它能跑）

参考仓库（本次已核对）：
- `moononournation/JC3636W518`
- `esp-arduino-libs/ESP32_JPEG`
- `lanyou1900/avilib`
- `pschatzmann/arduino-libhelix`

上游可用方案不是“通用播放器”，而是“预处理 + 流式播放”：

1. 视频格式前置约束
- 容器：AVI
- 视频：MJPEG
- 音频：MP3
- 分辨率：常用 360x360

2. 运行时策略
- SD 流式读取，每次只处理一个 frame/chunk
- 固定缓冲区复用，不做大规模动态分配
- 视频晚点就丢帧，保证主循环和音频不断流

3. 图片链路
- JPEG 不是“只要是 jpg 都能解”
- progressive 或某些编码参数可能导致空白/失败

4. 音频链路
- MP3(Helix) + I2S，通常独立高优先级任务

---

## 4. 当前“电子相册空白图”问题的工程判断

症状：
- 图片布局位置居中已正确
- 但内容区域出现空白

高概率原因：
1. 输入 JPEG 不在当前解码器稳定支持集合中（编码特征问题）
2. LVGL raw 路径接入成功但像素产出失败
3. 图片过大/渐进式等触发静默失败

低概率原因：
- 纯 UI 定位错误（目前位置和容器行为看已基本排除）

---

## 5. 实施总策略（避免大爆改）

总原则：
- 先让图片链路“稳定可复现”，再加 MP3/视频
- 先功能稳定，再拆文件重构

建议分两阶段：

### 阶段 A（低风险）
- 继续在 `main.cpp` 内推进
- 用统一前缀函数把媒体逻辑隔离（逻辑模块化）
- 快速收敛问题，减少重构噪音

### 阶段 B（可交接）
- 迁移到 `src/media/*` + `include/media/*`
- 明确模块边界与 API

推荐模块边界：
- `media_storage`：SD 挂载、扫描、索引
- `media_photo`：图片解码与缩放居中
- `media_audio`：MP3 解码/I2S 任务
- `media_video`：AVI demux + MJPEG 解码 + 帧调度
- `media_ui_bridge`：LVGL 控件状态桥接

---

## 6. v1 支持格式契约（必须先限制）

图片：
- `.jpg` `.jpeg` `.sjpg`
- 优先 baseline JPEG
- 长边建议 <= 1024

视频：
- `.avi`（MJPEG + MP3）
- 推荐 360x360
- 推荐 12-20 fps

音频：
- `.mp3`
- 推荐 CBR 96-192 kbps

---

## 7. 资源与任务模型（建议配置）

建议初始缓冲预算（后续按日志调整）：
- JPEG 输入缓冲：256-512 KB
- RGB565 帧缓冲（360x360）：约 259 KB
- MP3 输入块：2-8 KB
- PCM ring buffer：16-32 KB

任务模型：
- 主循环：UI + WS + 轻量状态
- 音频任务（独立高优先级）：解码 MP3 并写 I2S
- 视频先单线程调度，若饥饿再拆任务

硬约束：
- 按钮回调中不做阻塞 SD 读
- 大缓冲尽量一次申请、循环复用
- 切页必须可安全停止并释放媒体状态

---

## 8. 推荐预处理命令（用于稳定输入）

视频转码（MP4 -> AVI MJPEG+MP3）：

```bash
ffmpeg -y -i input.mp4 -c:a mp3 -b:a 128k -ar 44100 -ac 2 \
  -c:v mjpeg -q:v 7 -vf "scale=-1:360:flags=lanczos,crop=360:360" \
  output_360_mjpeg_mp3.avi
```

图片标准化：

```bash
ffmpeg -y -i input.jpg -vf "scale='min(1024,iw)':-1" -q:v 3 output.jpg
```

---

## 9. 里程碑计划（下一位同事直接执行）

M1（优先级最高）：图片可靠性基线
- 仅用已标准化 baseline JPEG 样本
- 补齐解码结果日志（尺寸/返回码/耗时）
- 通过标准：连续 20+ 次切换无空白、无假死

M2：MP3 独立播放
- SD 读取 + Helix + I2S
- 支持 pause/stop 与切页清理
- 通过标准：连续 10 分钟无看门狗/崩溃

M3：AVI 视频（无音频）
- demux + MJPEG decode + 丢帧策略
- 通过标准：360x360 可稳定播放

M4：AVI + MP3 合流
- 音频任务并行 + 视频时序
- 通过标准：5 分钟无明显漂移爆炸

M5：媒体页产品化
- Photo/Music/Video 模式切换
- 触控热区适配圆屏
- 错误提示可读且可恢复

---

## 10. 电子相册功能下一步（你们马上要做的）

下一步建议只做相册线，不并行开视频：

1. 先建立“已知可解码”图片样本集（SD 内单独目录）
2. 相册页新增调试信息：
- 文件名
- 解码尺寸
- 解码耗时
- 失败原因码
3. 增加“解码回退策略”：
- LVGL 路径失败时，切备用路径（直接解码绘制）
4. 做一轮真实设备压力回归：
- 快速左右切换
- 长按回主页再进入
- 插拔 SD 后重扫

---

## 11. 交接验证清单

功能验收：
- SD 挂载状态正确显示
- 相册 Prev/Reload/Next 全可点击且稳定
- 图片不是“位置正确但内容空白”

稳定性验收：
- 高频翻页无 UI 假死
- 多次进出相册页无内存持续增长
- 30 分钟混合操作不重启

可观测性验收：
- 串口日志可直接定位失败点
- 屏幕状态文案与真实状态一致

---

## 12. 备注

- 本文档是“媒体专项总入口”，用于减少接手信息散落。
- 详细推导与外部来源证据仍保留在两份 development 文档中，便于深挖。

