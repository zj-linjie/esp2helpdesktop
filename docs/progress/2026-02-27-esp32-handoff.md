# ESP32 接力开发交接文档（2026-02-27）

## 1. 文档目的

这份文档用于把当前 `esp2helpdesktop` 项目状态完整交接给下一位同事，确保可在同一块 `JC3636W518C (ESP32-S3)` 硬件上继续开发，并在后续继续由 AI 协助时能无缝衔接。

## 2. 当前基线（务必先看）

- 代码分支：`main`（跟踪 `new-origin/main`）
- 最近已提交里程碑：
  - `524c536`：设置/诊断页 + 触摸交互修复
  - `c73f059`：系统监控页 + 时钟页（NTP）
  - `2d3cd1e`：JC3636W518C 上板点亮 + 滑页/长按返回
- 当前本地有**未提交改动**（关键）：
  - `esp32-firmware/src/main.cpp`：新增第 5 页 `Inbox & Tasks`，并扩展多类 WS 消息解析
  - `esp32-firmware/src/config.h`：写入本地 WiFi 与 WS 地址
  - 未跟踪：`backups/`、`esp32-firmware/compile_commands.json`、`esp32-firmware/src/lv_conf.h`

## 3. 硬件与连接信息

- 设备型号：`JC3636W518C`（ESP32-S3，360x360 圆屏）
- 当前有效串口（本机曾识别）：`/dev/cu.usbmodem21101`
- 关键引脚映射文件：`esp32-firmware/src/display/pincfg.h`
  - 已确认使用 W518C 映射，不是 K518 映射
- 预装固件备份目录（已完成）：
  - `backups/esp32_preinstall_20260227_175918/`
  - 含 `full_16MB.bin` 与分区镜像

## 4. 固件当前可用功能（真实硬件已验证）

页面总数：`5`（底部页码 `1/5 ... 5/5`）

1. `Home`：显示 `ESP32 Desktop`、WiFi、WS 状态  
2. `System Monitor`：CPU/MEM 圆环 + 网络速率  
3. `Clock`：NTP 时间（已修复时区为 `UTC-8`）  
4. `Settings & Diagnostics`：
   - 按钮：`WiFi Reconnect` / `WS Reconnect` / `NTP Sync` / `Reboot`
   - 亮度滑块：5-100%，释放时持久化
5. `Inbox & Tasks`（未提交功能）：
   - 消息列表浏览：`Prev/Next`
   - 任务动作：`Acknowledge` / `Mark Done`

触控交互：
- 左右滑动切换页面
- 长按屏幕中心约 `800ms` 回到首页

## 5. WebSocket 协议现状（同事最常接手点）

### 5.1 ESP32 -> 服务端

- `handshake`
- `heartbeat`（每 5 秒）
- `task_action`（来自 Inbox 页按钮）

### 5.2 服务端 -> ESP32（已在固件解析）

- `handshake_ack`
- `system_stats` / `system_info`
- `ai_conversation`
- `ai_status`
- `task_card` / `task` / `todo` / `notification` / `reminder`
- `app_launched` / `launch_app_response` / `command_result`

### 5.3 现存协议缺口

`electron-app/src/main/websocket.ts` 当前 `handleMessage()` 里还未处理 `task_action`，会落到“未知消息类型”日志。  
下一位同事如果要把 Inbox 动作闭环，优先在该文件新增 `task_action` 分支（存储、转发或执行）。

## 6. 本机复现步骤（后端 + 固件）

### 6.1 启动 Electron 后端

```bash
cd /Users/apple/dev/esp2helpdesktop/electron-app
npm install
npm start
```

确认：
- Vite 页面可打开
- WebSocket 监听 `8765`

### 6.2 构建与烧录固件

```bash
cd /Users/apple/dev/esp2helpdesktop/esp32-firmware

# 如首次需要（可选）
python3.12 -m venv .venv-pio312
./.venv-pio312/bin/python -m pip install -U pip platformio

# 编译
./.venv-pio312/bin/python -m platformio run -e esp32-s3-devkit

# 烧录（端口按实际调整）
./.venv-pio312/bin/python -m platformio run -e esp32-s3-devkit -t upload --upload-port /dev/cu.usbmodem21101

# 串口日志
./.venv-pio312/bin/python -m platformio device monitor --port /dev/cu.usbmodem21101 --baud 115200
```

### 6.3 串口/USB 快速检查

```bash
ls /dev/cu.usbmodem* /dev/cu.usbserial* 2>/dev/null
ioreg -p IOUSB -w0 -l | rg -i "esp|usb jtag|serial"
```

## 7. 黑屏排查（这块已踩过坑）

按优先级执行：

1. 先看物理连接：数据线和 Type-C 接口是否松动（已出现过“线松导致黑屏”）
2. 看系统是否识别串口：无串口则优先换线/换口
3. 看串口日志是否出现：
   - `[LCD] init start`
   - `[LCD] touch init=1 begin=1 ready=1`
   - `[WebSocket] connected`
4. 若有日志但屏幕暗：切到 Settings 页检查亮度是否过低
5. 若触摸初始化失败，回查 `pincfg.h` 是否仍为 `JC3636W518C` 映射

## 8. 预装系统恢复（需要时）

镜像目录：
- `backups/esp32_preinstall_20260227_175918/full_16MB.bin`

示例恢复命令（谨慎执行）：

```bash
esptool.py --chip esp32s3 --port /dev/cu.usbmodem21101 --baud 921600 erase_flash
esptool.py --chip esp32s3 --port /dev/cu.usbmodem21101 --baud 921600 write_flash 0x0 /Users/apple/dev/esp2helpdesktop/backups/esp32_preinstall_20260227_175918/full_16MB.bin
```

## 9. 接手开发建议（按优先级）

1. 先把当前未提交改动整理成一次干净提交（尤其 `main.cpp` 的 Inbox 页）
2. 在 `websocket.ts` 增加 `task_action` 处理闭环
3. 补一份轻量协议文档（消息类型 + 字段）避免前后端漂移
4. 把 `backups/`、`compile_commands.json`、临时文件纳入 `.gitignore` 或明确归档策略
5. 每次阶段结束，在 `docs/progress/` 新增一条“日期+进展”记录，便于后续继续 AI 协作

## 10. 给下一次 AI 协作的最小输入模板

可直接复制下面文本给 AI：

```text
项目路径：/Users/apple/dev/esp2helpdesktop
硬件：JC3636W518C（ESP32-S3），串口当前是 /dev/cu.usbmodem21101（若变化我会补充）
当前目标：<请填本次要做的功能>
参考交接文档：docs/progress/2026-02-27-esp32-handoff.md
请先检查 git status 和 docs/progress，再继续编码并可直接编译烧录验证
```
